<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetricsCollector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Sports Data ETL Pipeline</a> &gt; <a href="index.source.html" class="el_package">com.sportsdata.etl.utils</a> &gt; <span class="el_source">MetricsCollector.java</span></div><h1>MetricsCollector.java</h1><pre class="source lang-java linenums">package com.sportsdata.etl.utils;

import com.sportsdata.etl.pipeline.EtlPipeline;
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicLong;

@Component
public class MetricsCollector {
    
<span class="nc" id="L20">    private static final Logger logger = LoggerFactory.getLogger(MetricsCollector.class);</span>
    
    private final MeterRegistry meterRegistry;
    
    // Counters for tracking record counts
    private final Counter teamsExtractedCounter;
    private final Counter playersExtractedCounter;
    private final Counter gamesExtractedCounter;
    
    private final Counter teamsLoadedCounter;
    private final Counter playersLoadedCounter;
    private final Counter gamesLoadedCounter;
    
    // Timers for performance tracking
    private final Timer extractionTimer;
    private final Timer transformationTimer;
    private final Timer loadTimer;
    
    // Custom metrics
<span class="nc" id="L39">    private final ConcurrentHashMap&lt;String, AtomicLong&gt; customMetrics = new ConcurrentHashMap&lt;&gt;();</span>
    
    @Autowired
<span class="nc" id="L42">    public MetricsCollector(MeterRegistry meterRegistry) {</span>
<span class="nc" id="L43">        this.meterRegistry = meterRegistry;</span>
        
        // Initialize counters
<span class="nc" id="L46">        this.teamsExtractedCounter = Counter.builder(&quot;etl.teams.extracted&quot;)</span>
<span class="nc" id="L47">            .description(&quot;Number of teams extracted&quot;)</span>
<span class="nc" id="L48">            .register(meterRegistry);</span>
            
<span class="nc" id="L50">        this.playersExtractedCounter = Counter.builder(&quot;etl.players.extracted&quot;)</span>
<span class="nc" id="L51">            .description(&quot;Number of players extracted&quot;)</span>
<span class="nc" id="L52">            .register(meterRegistry);</span>
            
<span class="nc" id="L54">        this.gamesExtractedCounter = Counter.builder(&quot;etl.games.extracted&quot;)</span>
<span class="nc" id="L55">            .description(&quot;Number of games extracted&quot;)</span>
<span class="nc" id="L56">            .register(meterRegistry);</span>
            
<span class="nc" id="L58">        this.teamsLoadedCounter = Counter.builder(&quot;etl.teams.loaded&quot;)</span>
<span class="nc" id="L59">            .description(&quot;Number of teams loaded&quot;)</span>
<span class="nc" id="L60">            .register(meterRegistry);</span>
            
<span class="nc" id="L62">        this.playersLoadedCounter = Counter.builder(&quot;etl.players.loaded&quot;)</span>
<span class="nc" id="L63">            .description(&quot;Number of players loaded&quot;)</span>
<span class="nc" id="L64">            .register(meterRegistry);</span>
            
<span class="nc" id="L66">        this.gamesLoadedCounter = Counter.builder(&quot;etl.games.loaded&quot;)</span>
<span class="nc" id="L67">            .description(&quot;Number of games loaded&quot;)</span>
<span class="nc" id="L68">            .register(meterRegistry);</span>
        
        // Initialize timers
<span class="nc" id="L71">        this.extractionTimer = Timer.builder(&quot;etl.extraction.duration&quot;)</span>
<span class="nc" id="L72">            .description(&quot;Time taken for data extraction&quot;)</span>
<span class="nc" id="L73">            .register(meterRegistry);</span>
            
<span class="nc" id="L75">        this.transformationTimer = Timer.builder(&quot;etl.transformation.duration&quot;)</span>
<span class="nc" id="L76">            .description(&quot;Time taken for data transformation&quot;)</span>
<span class="nc" id="L77">            .register(meterRegistry);</span>
            
<span class="nc" id="L79">        this.loadTimer = Timer.builder(&quot;etl.load.duration&quot;)</span>
<span class="nc" id="L80">            .description(&quot;Time taken for data loading&quot;)</span>
<span class="nc" id="L81">            .register(meterRegistry);</span>
<span class="nc" id="L82">    }</span>
    
    public void recordExtractionMetrics(EtlPipeline.ExtractedData extractedData) {
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if (extractedData == null) {</span>
<span class="nc" id="L86">            return;</span>
        }
        
<span class="nc bnc" id="L89" title="All 2 branches missed.">        if (extractedData.getTeams() != null) {</span>
<span class="nc" id="L90">            int teamCount = extractedData.getTeams().size();</span>
<span class="nc" id="L91">            teamsExtractedCounter.increment(teamCount);</span>
<span class="nc" id="L92">            logger.debug(&quot;Recorded extraction metrics: {} teams&quot;, teamCount);</span>
        }
        
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (extractedData.getPlayers() != null) {</span>
<span class="nc" id="L96">            int playerCount = extractedData.getPlayers().size();</span>
<span class="nc" id="L97">            playersExtractedCounter.increment(playerCount);</span>
<span class="nc" id="L98">            logger.debug(&quot;Recorded extraction metrics: {} players&quot;, playerCount);</span>
        }
        
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (extractedData.getGames() != null) {</span>
<span class="nc" id="L102">            int gameCount = extractedData.getGames().size();</span>
<span class="nc" id="L103">            gamesExtractedCounter.increment(gameCount);</span>
<span class="nc" id="L104">            logger.debug(&quot;Recorded extraction metrics: {} games&quot;, gameCount);</span>
        }
<span class="nc" id="L106">    }</span>
    
    public void recordTransformationMetrics(EtlPipeline.TransformedData transformedData) {
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (transformedData == null) {</span>
<span class="nc" id="L110">            return;</span>
        }
        
        // Record transformation quality metrics
<span class="nc" id="L114">        recordCustomMetric(&quot;transformation.teams.processed&quot;, </span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            transformedData.getTeams() != null ? transformedData.getTeams().size() : 0);</span>
<span class="nc" id="L116">        recordCustomMetric(&quot;transformation.players.processed&quot;, </span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            transformedData.getPlayers() != null ? transformedData.getPlayers().size() : 0);</span>
<span class="nc" id="L118">        recordCustomMetric(&quot;transformation.games.processed&quot;, </span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">            transformedData.getGames() != null ? transformedData.getGames().size() : 0);</span>
        
<span class="nc" id="L121">        logger.debug(&quot;Recorded transformation metrics&quot;);</span>
<span class="nc" id="L122">    }</span>
    
    public void recordLoadMetrics(EtlPipeline.LoadResult loadResult) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (loadResult == null) {</span>
<span class="nc" id="L126">            return;</span>
        }
        
<span class="nc" id="L129">        teamsLoadedCounter.increment(loadResult.getTeamsLoaded());</span>
<span class="nc" id="L130">        playersLoadedCounter.increment(loadResult.getPlayersLoaded());</span>
<span class="nc" id="L131">        gamesLoadedCounter.increment(loadResult.getGamesLoaded());</span>
        
        // Record success/failure metrics
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (loadResult.isSuccess()) {</span>
<span class="nc" id="L135">            recordCustomMetric(&quot;load.success&quot;, 1);</span>
        } else {
<span class="nc" id="L137">            recordCustomMetric(&quot;load.failure&quot;, 1);</span>
        }
        
<span class="nc" id="L140">        logger.debug(&quot;Recorded load metrics: {} teams, {} players, {} games loaded&quot;, </span>
<span class="nc" id="L141">            loadResult.getTeamsLoaded(), loadResult.getPlayersLoaded(), loadResult.getGamesLoaded());</span>
<span class="nc" id="L142">    }</span>
    
    public Timer.Sample startExtractionTimer() {
<span class="nc" id="L145">        return Timer.start(meterRegistry);</span>
    }
    
    public void stopExtractionTimer(Timer.Sample sample) {
<span class="nc" id="L149">        sample.stop(extractionTimer);</span>
<span class="nc" id="L150">    }</span>
    
    public Timer.Sample startTransformationTimer() {
<span class="nc" id="L153">        return Timer.start(meterRegistry);</span>
    }
    
    public void stopTransformationTimer(Timer.Sample sample) {
<span class="nc" id="L157">        sample.stop(transformationTimer);</span>
<span class="nc" id="L158">    }</span>
    
    public Timer.Sample startLoadTimer() {
<span class="nc" id="L161">        return Timer.start(meterRegistry);</span>
    }
    
    public void stopLoadTimer(Timer.Sample sample) {
<span class="nc" id="L165">        sample.stop(loadTimer);</span>
<span class="nc" id="L166">    }</span>
    
    public void recordCustomMetric(String metricName, long value) {
<span class="nc" id="L169">        customMetrics.computeIfAbsent(metricName, k -&gt; {</span>
<span class="nc" id="L170">            AtomicLong counter = new AtomicLong(0);</span>
<span class="nc" id="L171">            meterRegistry.gauge(&quot;etl.custom.&quot; + k, counter, AtomicLong::get);</span>
<span class="nc" id="L172">            return counter;</span>
<span class="nc" id="L173">        }).set(value);</span>
<span class="nc" id="L174">    }</span>
    
    public void incrementCustomMetric(String metricName) {
<span class="nc" id="L177">        customMetrics.computeIfAbsent(metricName, k -&gt; {</span>
<span class="nc" id="L178">            AtomicLong counter = new AtomicLong(0);</span>
<span class="nc" id="L179">            meterRegistry.gauge(&quot;etl.custom.&quot; + k, counter, AtomicLong::get);</span>
<span class="nc" id="L180">            return counter;</span>
<span class="nc" id="L181">        }).incrementAndGet();</span>
<span class="nc" id="L182">    }</span>
    
    public void recordPipelineExecution(String pipelineId, LocalDateTime startTime, LocalDateTime endTime, boolean success) {
<span class="nc" id="L185">        Duration duration = Duration.between(startTime, endTime);</span>
        
<span class="nc" id="L187">        Timer pipelineTimer = Timer.builder(&quot;etl.pipeline.duration&quot;)</span>
<span class="nc" id="L188">            .description(&quot;Total pipeline execution time&quot;)</span>
<span class="nc" id="L189">            .tag(&quot;success&quot;, String.valueOf(success))</span>
<span class="nc" id="L190">            .register(meterRegistry);</span>
            
<span class="nc" id="L192">        pipelineTimer.record(duration);</span>
        
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if (success) {</span>
<span class="nc" id="L195">            incrementCustomMetric(&quot;pipeline.success&quot;);</span>
        } else {
<span class="nc" id="L197">            incrementCustomMetric(&quot;pipeline.failure&quot;);</span>
        }
        
<span class="nc" id="L200">        logger.info(&quot;Recorded pipeline execution metrics: {} ({}ms, success={})&quot;, </span>
<span class="nc" id="L201">            pipelineId, duration.toMillis(), success);</span>
<span class="nc" id="L202">    }</span>
    
    public void recordDataQualityScore(double qualityScore) {
<span class="nc" id="L205">        recordCustomMetric(&quot;data.quality.score&quot;, Math.round(qualityScore * 100));</span>
<span class="nc" id="L206">    }</span>
    
    public long getCustomMetric(String metricName) {
<span class="nc" id="L209">        AtomicLong metric = customMetrics.get(metricName);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        return metric != null ? metric.get() : 0L;</span>
    }
    
    public void resetCustomMetrics() {
<span class="nc" id="L214">        customMetrics.clear();</span>
<span class="nc" id="L215">        logger.info(&quot;Custom metrics reset&quot;);</span>
<span class="nc" id="L216">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>