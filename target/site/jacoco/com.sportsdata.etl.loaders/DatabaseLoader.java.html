<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Sports Data ETL Pipeline</a> &gt; <a href="index.source.html" class="el_package">com.sportsdata.etl.loaders</a> &gt; <span class="el_source">DatabaseLoader.java</span></div><h1>DatabaseLoader.java</h1><pre class="source lang-java linenums">package com.sportsdata.etl.loaders;

import com.sportsdata.etl.models.Game;
import com.sportsdata.etl.models.Player;
import com.sportsdata.etl.models.Team;
import com.sportsdata.etl.pipeline.EtlPipeline;
import com.sportsdata.etl.repositories.GameRepository;
import com.sportsdata.etl.repositories.PlayerRepository;
import com.sportsdata.etl.repositories.TeamRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
<span class="nc" id="L19">public class DatabaseLoader {</span>
    
<span class="nc" id="L21">    private static final Logger logger = LoggerFactory.getLogger(DatabaseLoader.class);</span>
    
    @Autowired
    private TeamRepository teamRepository;
    
    @Autowired
    private PlayerRepository playerRepository;
    
    @Autowired
    private GameRepository gameRepository;
    
    @Transactional
    public EtlPipeline.LoadResult loadAllData(EtlPipeline.TransformedData transformedData) {
<span class="nc" id="L34">        EtlPipeline.LoadResult result = new EtlPipeline.LoadResult();</span>
        
        try {
<span class="nc" id="L37">            logger.info(&quot;Starting database loading process&quot;);</span>
            
            // Load teams first (as they may be referenced by other entities)
<span class="nc" id="L40">            int teamsLoaded = loadTeams(transformedData.getTeams());</span>
<span class="nc" id="L41">            result.setTeamsLoaded(teamsLoaded);</span>
            
            // Load players (they reference teams)
<span class="nc" id="L44">            int playersLoaded = loadPlayers(transformedData.getPlayers());</span>
<span class="nc" id="L45">            result.setPlayersLoaded(playersLoaded);</span>
            
            // Load games (they reference teams)
<span class="nc" id="L48">            int gamesLoaded = loadGames(transformedData.getGames());</span>
<span class="nc" id="L49">            result.setGamesLoaded(gamesLoaded);</span>
            
<span class="nc" id="L51">            result.setSuccess(true);</span>
            
<span class="nc" id="L53">            logger.info(&quot;Database loading completed successfully: {} teams, {} players, {} games&quot;, </span>
<span class="nc" id="L54">                teamsLoaded, playersLoaded, gamesLoaded);</span>
            
<span class="nc" id="L56">        } catch (Exception e) {</span>
<span class="nc" id="L57">            logger.error(&quot;Database loading failed&quot;, e);</span>
<span class="nc" id="L58">            result.setSuccess(false);</span>
<span class="nc" id="L59">            result.setErrorMessage(e.getMessage());</span>
<span class="nc" id="L60">            throw e; // Re-throw to trigger transaction rollback</span>
<span class="nc" id="L61">        }</span>
        
<span class="nc" id="L63">        return result;</span>
    }
    
    private int loadTeams(List&lt;Team&gt; teams) {
<span class="nc bnc" id="L67" title="All 4 branches missed.">        if (teams == null || teams.isEmpty()) {</span>
<span class="nc" id="L68">            logger.info(&quot;No teams to load&quot;);</span>
<span class="nc" id="L69">            return 0;</span>
        }
        
<span class="nc" id="L72">        logger.info(&quot;Loading {} teams into database&quot;, teams.size());</span>
        
        try {
<span class="nc" id="L75">            List&lt;Team&gt; savedTeams = teamRepository.saveAll(teams);</span>
<span class="nc" id="L76">            logger.info(&quot;Successfully loaded {} teams&quot;, savedTeams.size());</span>
<span class="nc" id="L77">            return savedTeams.size();</span>
<span class="nc" id="L78">        } catch (Exception e) {</span>
<span class="nc" id="L79">            logger.error(&quot;Failed to load teams&quot;, e);</span>
<span class="nc" id="L80">            throw new RuntimeException(&quot;Team loading failed&quot;, e);</span>
        }
    }
    
    private int loadPlayers(List&lt;Player&gt; players) {
<span class="nc bnc" id="L85" title="All 4 branches missed.">        if (players == null || players.isEmpty()) {</span>
<span class="nc" id="L86">            logger.info(&quot;No players to load&quot;);</span>
<span class="nc" id="L87">            return 0;</span>
        }
        
<span class="nc" id="L90">        logger.info(&quot;Loading {} players into database&quot;, players.size());</span>
        
        try {
<span class="nc" id="L93">            List&lt;Player&gt; savedPlayers = playerRepository.saveAll(players);</span>
<span class="nc" id="L94">            logger.info(&quot;Successfully loaded {} players&quot;, savedPlayers.size());</span>
<span class="nc" id="L95">            return savedPlayers.size();</span>
<span class="nc" id="L96">        } catch (Exception e) {</span>
<span class="nc" id="L97">            logger.error(&quot;Failed to load players&quot;, e);</span>
<span class="nc" id="L98">            throw new RuntimeException(&quot;Player loading failed&quot;, e);</span>
        }
    }
    
    private int loadGames(List&lt;Game&gt; games) {
<span class="nc bnc" id="L103" title="All 4 branches missed.">        if (games == null || games.isEmpty()) {</span>
<span class="nc" id="L104">            logger.info(&quot;No games to load&quot;);</span>
<span class="nc" id="L105">            return 0;</span>
        }
        
<span class="nc" id="L108">        logger.info(&quot;Loading {} games into database&quot;, games.size());</span>
        
        try {
<span class="nc" id="L111">            List&lt;Game&gt; savedGames = gameRepository.saveAll(games);</span>
<span class="nc" id="L112">            logger.info(&quot;Successfully loaded {} games&quot;, savedGames.size());</span>
<span class="nc" id="L113">            return savedGames.size();</span>
<span class="nc" id="L114">        } catch (Exception e) {</span>
<span class="nc" id="L115">            logger.error(&quot;Failed to load games&quot;, e);</span>
<span class="nc" id="L116">            throw new RuntimeException(&quot;Game loading failed&quot;, e);</span>
        }
    }
    
    @Transactional
    public void loadTeamsOnly(List&lt;Team&gt; teams) {
<span class="nc" id="L122">        loadTeams(teams);</span>
<span class="nc" id="L123">    }</span>
    
    @Transactional
    public void loadPlayersOnly(List&lt;Player&gt; players) {
<span class="nc" id="L127">        loadPlayers(players);</span>
<span class="nc" id="L128">    }</span>
    
    @Transactional
    public void loadGamesOnly(List&lt;Game&gt; games) {
<span class="nc" id="L132">        loadGames(games);</span>
<span class="nc" id="L133">    }</span>
    
    public long getTeamCount() {
<span class="nc" id="L136">        return teamRepository.count();</span>
    }
    
    public long getPlayerCount() {
<span class="nc" id="L140">        return playerRepository.count();</span>
    }
    
    public long getGameCount() {
<span class="nc" id="L144">        return gameRepository.count();</span>
    }
    
    @Transactional
    public void clearAllData() {
<span class="nc" id="L149">        logger.warn(&quot;Clearing all data from database&quot;);</span>
        
        // Delete in reverse order of dependencies
<span class="nc" id="L152">        gameRepository.deleteAll();</span>
<span class="nc" id="L153">        playerRepository.deleteAll();</span>
<span class="nc" id="L154">        teamRepository.deleteAll();</span>
        
<span class="nc" id="L156">        logger.info(&quot;All data cleared from database&quot;);</span>
<span class="nc" id="L157">    }</span>
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>